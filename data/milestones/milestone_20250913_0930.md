# Pool Scout Pro - System Milestone Documentation

## System Overview

Pool Scout Pro is an inspection report management system for Sacramento County pool inspections. The system searches EMD (Environmental Management Department) records, downloads PDF inspection reports, extracts data, and stores it in a normalized database with inspection ID-based duplicate detection and date verification.

**Core Philosophy**: Download ‚Üí Extract ‚Üí Database (transactional flow ensures data consistency)

**Current System Status**: Enterprise-ready system with comprehensive resilience architecture. Search and download systems operational with intelligent failure recovery, health monitoring, automatic retry mechanisms, separated database architecture for scalability, multi-session Selenium configuration for concurrent operations, and comprehensive equipment tracking with violation deadline extraction.

!!! CRITICAL FOR ALL FUTURE CHATS !!!

**MANDATORY FIRST ACTION**: Any AI assistant must read and acknowledge these development rules before making ANY code changes:

1. **ALWAYS GET PERMISSION BEFORE GENERATING CODE** - Never auto-generate code without explicit permission
2. **USE INTEGRATED DEVELOPMENT SYSTEM** - MANDATORY dev-tools workflow
3. **NEVER use sed, manual editing, or direct file modification**
4. **ALL changes via: ./dev-tools/dev-workflow.sh edit or patch**
5. **Incremental development with validation at each step**

VIOLATION OF THESE RULES = IMMEDIATE CORRECTION REQUIRED

**Acknowledgment required**: "I will follow the mandatory dev-tools workflow for all changes"

!!! ALWAYS INCLUDE THE FOLLOWING IN EVERY MILESTONE UPDATE !!!

**DEVELOPMENT RULES - MANDATORY ADHERENCE**
1. **ALWAYS GET PERMISSION BEFORE GENERATING CODE** - Confirm understanding before any code generation
2. **USE INTEGRATED DEVELOPMENT SYSTEM** - ALWAYS use dev-tools workflow, never manual file editing
3. **INCREMENTAL DEVELOPMENT** - One step at a time, confirm each change works
4. **COPY-PASTE READY COMMANDS** - All commands must run from project root
5. **HYBRID FILE EDITING APPROACH** - Short files (<100 lines): complete replacement, Medium (100-500): section replacement, Long (>500): external snippets
6. **NEVER MODIFY FILES WITHOUT SEEING THEM FIRST** - Always examine current content
7. **CLEAR STEP DELINEATION** - Structure commands with clear step comments
8. **USE DEV-TOOLS FOR ALL CHANGES** - Apply changes via safe-edit.sh or safe-patch.sh, never direct file modification
9. **ALWAYS VALIDATE SYNTAX** - Use dev-workflow.sh validate before any changes
10. **EFFICIENT CONTENT HANDLING** - For large files, generate commands without showing full content
11. **NEVER USE TEST/SAMPLE DATA IN PRODUCTION** - Do not create test/sample reports, or dummy data in the production database or file system. Use real data from search results only, or work in a separate development environment.
12. **Keep responses short and to the point** - Avoiding detailed explanations unless explicitly requested, to conserve chat space.

**üõ†Ô∏è MANDATORY DEV-TOOLS WORKFLOW**
- `./dev-tools/dev-workflow.sh validate <file>` - Check syntax BEFORE changes
- `./dev-tools/dev-workflow.sh edit <target> <new>` - Safe file replacement with auto-backup
- `./dev-tools/dev-workflow.sh patch <target> <patch>` - Apply git patches safely
- `./dev-tools/dev-workflow.sh rollback <file>` - Emergency restore from backup
- `./dev-tools/dev-workflow.sh restart` - Test changes with service restart
- **NEVER manually edit files** - Use dev-tools for ALL modifications

MILESTONE MAINTENANCE INSTRUCTIONS FOR FUTURE CHATS
This milestone contains ONLY:
‚úÖ Project structure and file purposes
‚úÖ Development rules and standards
‚úÖ System capabilities and configuration
‚úÖ Deployment procedures
‚úÖ Current status and ongoing development needs

Do NOT add to this milestone:
‚ùå Resolved issues (transient information)
‚ùå Temporary status updates
‚ùå "Next phase priorities" or similar changing content
‚ùå Backup files, enhanced files, or dated suffixes in structure

!!! ALWAYS INCLUDE THE ABOVE IN EVERY MILESTONE UPDATE !!!

---

## Integrated Development System

### **üõ†Ô∏è Safe Development Workflow**

Pool Scout Pro includes a comprehensive development toolkit that enforces safety protocols and prevents code corruption. **ALL CODE CHANGES MUST USE THIS SYSTEM**.

### **Development Toolkit Structure**
```
dev-tools/
‚îú‚îÄ‚îÄ dev-workflow.sh          # Main workflow coordinator - PRIMARY INTERFACE
‚îú‚îÄ‚îÄ validate-syntax.sh       # Python syntax validation with import testing
‚îú‚îÄ‚îÄ safe-edit.sh            # Safe file replacement with automatic backups
‚îú‚îÄ‚îÄ safe-patch.sh           # Git-style patch application with rollback
‚îú‚îÄ‚îÄ rollback.sh             # Quick restore from timestamped backups
‚îú‚îÄ‚îÄ setup-git-workflow.sh   # Git branch setup for development
‚îî‚îÄ‚îÄ workflow.sh             # Testing and deployment coordination
```

### **üìÑ Mandatory Development Process**
1. **Git Branch Strategy**: All changes on development branch
2. **Pre-flight Validation**: Syntax check before ANY file modification
3. **Automatic Backups**: Every change creates `filename.YYYYMMDD_HHMMSS` backup in `data/backups/`
4. **Atomic Operations**: Backup ‚Üí Validate ‚Üí Apply ‚Üí Verify ‚Üí Success/Rollback
5. **Zero-Downtime Recovery**: Instant rollback if validation fails
6. **Service Integration**: Direct testing via service restart commands

### **‚ö° Required Workflow Commands**

**NEVER manually edit files - ALWAYS use these commands:**

```bash
# Step 1: ALWAYS validate syntax first
./dev-tools/dev-workflow.sh validate src/services/pdf_downloader.py

# Step 2: Apply changes via safe replacement
./dev-tools/dev-workflow.sh edit src/services/pdf_downloader.py /tmp/updated_file.py

# Alternative: Apply git-style patches for large files
./dev-tools/dev-workflow.sh patch src/services/pdf_downloader.py /tmp/changes.patch

# Step 3: Test changes immediately
./dev-tools/dev-workflow.sh restart

# Emergency: Rollback if issues detected
./dev-tools/dev-workflow.sh rollback src/services/pdf_downloader.py
```

### **üõ°Ô∏è Safety Features**
- **Pre-flight Validation**: Python compilation + import testing before application
- **Automatic Backups**: Timestamped backups prevent data loss
- **Rollback on Failure**: Auto-restore if post-application validation fails
- **Import Testing**: Ensures modified Python modules can be imported correctly
- **Service Integration**: Immediate testing via manage.sh integration
- **Git Integration**: Development branch isolation from production code

### **üö´ Prohibited Actions**
- **NEVER** manually edit files with nano/vim/sed
- **NEVER** apply changes without pre-validation
- **NEVER** skip the backup process
- **NEVER** modify files on main branch directly
- **NEVER** ignore validation failures

**CRITICAL**: This development system is **MANDATORY** for all code changes. It prevents the production system corruption that the development rules are designed to avoid.

---

## System Architecture

### **Separation of Operations**

The system maintains strict separation between:

1. **Search Operations** (SearchService) - EMD website interaction and facility discovery
2. **Download Operations** (PDFDownloader) - PDF file acquisition and transactional processing with enterprise resilience
3. **Extraction Operations** (PDFExtractor) - PDF content parsing with comprehensive equipment tracking and violation deadline extraction
4. **Database Operations** (DatabaseService) - Data persistence and integrity with enterprise architecture
5. **Web Interface** (Flask) - User interaction and API endpoints
6. **Health Monitoring** (SeleniumHealthService) - Container health verification and recovery
7. **External Monitoring** - Independent Selenium monitoring with restart capability and alerting
8. **Retry Management** - Dead letter queue processing and scheduled retry operations
9. **Multi-Session Management** - Concurrent session handling with intelligent resource management

**Critical**: Each operation is isolated and can fail independently without corrupting others.

---

## Enhanced Features

### **Multi-Session Selenium Architecture**
- **Purpose**: Eliminate single session bottleneck and enable concurrent PDF downloads
- **Configuration**: 5 concurrent sessions (increased from 1) with resource management
- **Benefits**: 5x Download Speed, Fault Tolerance, Resource Optimization, Graceful Degradation
- **Session Management**: Automatic cleanup of idle and stuck sessions with configurable thresholds
- **Health Monitoring**: Per-session health tracking with utilization monitoring

### **Hybrid Monitoring Architecture**
- **Application Monitor** (robust_selenium_monitor.py): Session management, cleanup, pre-download health verification
- **External Monitor** (/usr/local/bin/selenium_monitor.sh): Container health, infrastructure restarts, system-level recovery via systemd timers
- **Division of Labor**: Fast session issues handled by application, infrastructure issues by external monitor

### **Enterprise Database Architecture**
- **Purpose**: Separate business data from operational data for scalability and data lifecycle management
- **Implementation**: Two-database architecture with clear separation of concerns
- **Databases**: `inspection_data.db` (business data), `system_management.db` (operational data)
- **Benefits**: Independent backup strategies, different retention policies, scalable to multiple counties

### **Comprehensive External Monitoring System**
- **Components**: Selenium Health Monitor via systemd timers, Container Restart Capability, Alerting System, Scheduled Retry Processing
- **Health Checks**: HTTP status endpoint monitoring with container readiness verification
- **Recovery Actions**: Automatic container restart, exponential backoff retry, failure escalation

### **Intelligent Download Retry Logic**
- **Implementation**: 3 immediate retry attempts with Selenium health checks, Selenium recovery with container restart, Mark for later retry, Dead letter queue
- **Retry Scheduling**: 1-hour delay for later retry attempts with retry_candidates view
- **Failure Classification**: Distinguishes infrastructure failures (Selenium) from content failures (network/PDF)

### **Inspection ID-Based Duplicate Detection**
- **Purpose**: Prevent duplicate downloads using precise inspection ID matching
- **Implementation**: Extracts inspection ID from PDF URLs for accurate duplicate checking
- **Logic**: Primary check via inspection_id, fallback to facility name with permissive threshold

### **Date Verification System**
- **Purpose**: Ensure inspection reports are saved with correct dates
- **Implementation**: Extracts actual inspection date from PDF content (Date Entered: MM/DD/YYYY)
- **Verification**: Compares PDF date vs search parameters with mismatch logging

### **Transactional Download Processing with Enterprise Resilience**
- **Features**: Single-Flight Lock, Atomic Operations, Failure Recovery, File Integrity, Progress Tracking, Health Monitoring
- **Multi-Level Retry**: 4-level resilience strategy from application retry to external monitoring
- **Queue Management**: Failed facility tracking with intelligent retry scheduling
- **Concurrent Processing**: Multiple PDF downloads with session management and resource optimization

### **Comprehensive Equipment Tracking**
- **Purpose**: Track all equipment types with detailed specifications for regulatory compliance and analytics
- **Equipment Types**: Filter Pumps (up to 3), Jet Pumps (up to 2), Filters (up to 2), Sanitizers (up to 2), Main Drains, Equalizers
- **Extraction Features**: Multi-line equipment parsing handles complex PDF formats
- **Analytics Ready**: Enables equipment analysis queries

### **Advanced Violation Processing**
- **Purpose**: Extract comprehensive violation data with corrective action deadlines for compliance tracking
- **Features**: Deadline Extraction, Clean Text Processing, Boundary Detection, Major Violation Detection, Severity Scoring
- **Database Fields**: Violation code, title, observations, code description, major flag, severity level, correction deadline days

---

## Directory Structure & File Purposes

```
pool_scout_pro/
‚îú‚îÄ‚îÄ dev-tools/                          # MANDATORY DEVELOPMENT SYSTEM
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ backups/                        # Automatic timestamped file backups
‚îÇ   ‚îú‚îÄ‚îÄ inspection_data.db              # Business data SQLite database
‚îÇ   ‚îú‚îÄ‚îÄ system_management.db            # Operational data SQLite database
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ core/                           # Core system utilities
‚îÇ   ‚îú‚îÄ‚îÄ services/                       # Business logic services
‚îÇ   ‚îî‚îÄ‚îÄ web/                            # Web application layer
‚îú‚îÄ‚îÄ templates/                          # Web interface
‚îÇ   ‚îî‚îÄ‚îÄ static/js/                      # Frontend JavaScript modules
‚îî‚îÄ‚îÄ /mnt/nas-pool-data/reports/2025/    # PDF file storage
```

---

## Database Schema

### **Business Data (inspection_data.db):**
- **facilities**: Enhanced facility master data with address normalization
- **inspection_reports**: Comprehensive inspection data with date verification
- **violations**: Enhanced violation details with deadline tracking
- **equipment**: Comprehensive equipment tracking with multiple pumps/filters/sanitizers

### **System Management Data (system_management.db):**
- **failed_downloads**: Failed download tracking with retry management
- **retry_queue**: Retry queue management
- **health_status**: System health monitoring
- **search_timing**: Performance monitoring

---

## API Endpoints

### **Search Operations**
- `POST /api/v1/reports/search-with-duplicates` - EMD search with duplicate detection
- `POST /api/v1/reports/existing-for-date` - Get saved reports for date

### **Download Operations**
- `POST /api/v1/downloads/start` - Initialize download process
- `GET /api/v1/downloads/progress` - Real-time download progress

---

## Infrastructure Configuration

### **Systemd Services**
- `pool-scout-pro.service` - Main application service
- `pool-scout-health.timer` - Health monitoring (every 2 minutes)
- `pool-scout-retry.timer` - Retry processing (every 15 minutes)

### **Selenium Container**
- **Container**: `selenium/standalone-firefox:latest`
- **Sessions**: 5 concurrent sessions with automatic management
- **Health Monitoring**: Application + external monitoring

### **Monitoring Scripts**
- **Selenium Monitor**: `/usr/local/bin/selenium_monitor.sh`
- **Retry Processor**: `/usr/local/bin/retry_job.sh`

---

## Current Development Status

### **‚úÖ Completed Major Features**
1. **Enterprise Resilience Architecture** - 4-level failure recovery with external monitoring
2. **Multi-Session Selenium** - 5 concurrent sessions with session management
3. **Comprehensive Equipment Tracking** - Database schema with detailed equipment fields
4. **Advanced Violation Processing** - Deadline extraction and cross-contamination prevention
5. **Two-Database Architecture** - Business data separated from operational data
6. **Date Verification System** - PDF date extraction with filename correction
7. **Real-time Progress Tracking** - Frontend polling with visual indicators
8. **Search Result Integration** - Proper saved facility marking instead of filtering
9. **Failed Download Retry System** - Complete retry integration with proper method calls
10. **External Monitoring System** - Systemd-based health monitoring with container restart

### **üîß Current Implementation Status**
**All Core Systems**: ‚úÖ **FULLY OPERATIONAL**
- EMD website search and PDF download with multi-session concurrent processing
- Comprehensive PDF data extraction with equipment tracking and violation deadline extraction
- Two-database architecture with comprehensive tracking and retry management
- Real-time web interface with dynamic UI state management
- Enterprise monitoring and resilience with systemd timer-based health checks

## Deployment Procedures

### **Production Deployment**
```bash
docker-compose up -d selenium
./manage.sh start
```

### **Health Verification**
```bash
./manage.sh status
curl -f http://localhost:4444/wd/hub/status
sudo systemctl list-timers | grep pool-scout
```

### **Database Initialization**
```bash
sqlite3 data/inspection_data.db < schemas/inspection_schema.sql
sqlite3 data/system_management.db < schemas/system_schema.sql
```

---

## System Capabilities

**Current Live Capabilities:**
- EMD Website Search with enhanced logging and performance tracking
- Intelligent PDF Download with multi-session concurrent downloads and enterprise resilience
- Comprehensive PDF Extraction with equipment tracking and violation deadline extraction
- Advanced Database Operations with two-database architecture and retry management
- Enhanced Web Interface with real-time progress and dynamic UI state management
- Enterprise Monitoring & Recovery with systemd timer-based health checks and automatic restart

---

**DON'T DELETE THIS**

This milestone document serves as the definitive reference for Pool Scout Pro's architecture, functionality, and critical fixes. It should be preserved and updated as the system evolves, not replaced or deleted.

---

*Last Updated: September 13, 2025*
*This milestone reflects all critical fixes and optimizations applied during development.*
